<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle de Manuten√ß√£o</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:Arial;background:#f4f6f8;margin:0;padding:20px}
h1{text-align:center}
form,.card{background:#fff;padding:15px;border-radius:8px;margin-bottom:20px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
input,textarea,select,button{width:100%;padding:8px;margin-top:8px}
button{background:#2563eb;color:#fff;border:0;border-radius:5px;cursor:pointer}
button:hover{opacity:.9}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:15px}
.photos img{width:100%;border-radius:5px;margin-top:5px}
.photos button{background:#dc2626;margin-top:5px}
small{color:#666}
</style>
</head>

<body>

<h1>üõ† Controle de Manuten√ß√£o</h1>

<form id="form">
  <input type="hidden" id="mid">

  <input id="local" placeholder="Local da manuten√ß√£o" required>
  <textarea id="descricao" placeholder="Descri√ß√£o" required></textarea>

  <input type="date" id="dataManutencao" required>
  <input id="responsavel" placeholder="Respons√°vel" required>

  <select id="status">
    <option value="aberto">Aberto</option>
    <option value="em andamento">Em andamento</option>
    <option value="finalizado">Finalizado</option>
  </select>

  <input type="file" id="fotos" multiple accept="image/*">

  <button>Salvar manuten√ß√£o</button>
</form>

<div class="grid" id="lista"></div>

<script>
const supabase = supabaseJs.createClient(
  "https://yydwtytjrjsbwycnfxlk.supabase.co",
  "sb_publishable_emSBOsbTZrSXtNxnBZihsw_du9yIkoX"
);

/* ===== COMPRESS√ÉO ===== */
function comprimirImagem(file){
  return new Promise(resolve=>{
    const img = new Image();
    img.src = URL.createObjectURL(file);
    img.onload = ()=>{
      const c = document.createElement("canvas");
      const max = 900;
      let w = img.width, h = img.height;

      if(w > h && w > max){ h *= max / w; w = max; }
      else if(h > max){ w *= max / h; h = max; }

      c.width = w; c.height = h;
      c.getContext("2d").drawImage(img,0,0,w,h);
      c.toBlob(b => resolve(b), "image/jpeg", 0.7);
    };
  });
}

/* ===== LISTAR ===== */
async function carregar(){
  const { data, error } = await supabase
    .from("manutencoes")
    .select("*")
    .order("created_at", { ascending:false });

  if(error){ console.error(error); return; }

  lista.innerHTML = "";

  data.forEach(m=>{
    lista.innerHTML += `
      <div class="card">
        <h3>${m.local}</h3>
        <small>${m.data} ‚Ä¢ ${m.responsavel} ‚Ä¢ <b>${m.status}</b></small>
        <p>${m.descricao}</p>
        <div class="photos" id="p${m.id}"></div>
        <button onclick="editar('${m.id}')">‚úèÔ∏è Editar</button>
      </div>
    `;
    carregarFotos(m.id);
  });
}

/* ===== FOTOS ===== */
async function carregarFotos(id){
  const { data } = await supabase.storage.from("fotos").list(id + "/");
  const div = document.getElementById("p"+id);
  if(!data || !div) return;

  div.innerHTML = "";
  data.forEach(f=>{
    const url = supabase.storage.from("fotos")
      .getPublicUrl(`${id}/${f.name}`).data.publicUrl;

    div.innerHTML += `
      <img src="${url}">
      <button onclick="removerFoto('${id}','${f.name}')">üóëÔ∏è Remover</button>
    `;
  });
}

async function removerFoto(id,nome){
  await supabase.storage.from("fotos").remove([`${id}/${nome}`]);
  carregar();
}

/* ===== SALVAR / EDITAR ===== */
form.onsubmit = async e => {
  e.preventDefault();

  const dados = {
    local: local.value,
    descricao: descricao.value,
    data: dataManutencao.value,
    responsavel: responsavel.value,
    status: status.value
  };

  let result;

  if(mid.value){
    result = await supabase
      .from("manutencoes")
      .update(dados)
      .eq("id", mid.value)
      .select()
      .single();
  }else{
    result = await supabase
      .from("manutencoes")
      .insert(dados)
      .select()
      .single();
  }

  if(result.error){
    console.error(result.error);
    alert("Erro ao salvar");
    return;
  }

  if(fotos.files.length){
    for(const f of fotos.files){
      const img = await comprimirImagem(f);
      await supabase.storage.from("fotos")
        .upload(`${result.data.id}/${Date.now()}.jpg`, img, { upsert:true });
    }
  }

  form.reset();
  mid.value = "";
  carregar();
};

/* ===== EDITAR ===== */
async function editar(id){
  const { data } = await supabase
    .from("manutencoes")
    .select("*")
    .eq("id", id)
    .single();

  mid.value = data.id;
  local.value = data.local;
  descricao.value = data.descricao;
  dataManutencao.value = data.data;
  responsavel.value = data.responsavel;
  status.value = data.status;

  window.scrollTo({top:0,behavior:"smooth"});
}

carregar();
</script>

</body>
</html>
