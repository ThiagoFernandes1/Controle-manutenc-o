<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle de Manuten√ß√£o</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:Arial;background:#f4f6f8;margin:0;padding:20px}
h1{text-align:center}
form,.card{background:#fff;padding:15px;border-radius:8px;margin-bottom:20px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
input,textarea,select,button{width:100%;padding:8px;margin-top:8px}
button{background:#2563eb;color:#fff;border:0;border-radius:5px;cursor:pointer}
button:hover{opacity:.9}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:15px}
.photos img{width:100%;border-radius:5px;margin-top:5px}
.photos button{background:#dc2626;margin-top:5px}
small{color:#666}
</style>
</head>

<body>

<h1>üõ† Controle de Manuten√ß√£o</h1>

<form id="form">
  <input type="hidden" id="id">

  <input id="local" placeholder="Local da manuten√ß√£o" required>
  <textarea id="descricao" placeholder="Descri√ß√£o" required></textarea>

  <input type="date" id="data" required>
  <input id="responsavel" placeholder="Respons√°vel" required>

  <select id="status">
    <option value="aberto">Aberto</option>
    <option value="em andamento">Em andamento</option>
    <option value="finalizado">Finalizado</option>
  </select>

  <input type="file" id="fotos" multiple accept="image/*">

  <button>Salvar manuten√ß√£o</button>
</form>

<div class="grid" id="lista"></div>

<script>
const supabaseUrl = "https://yydwtytjrjsbwycnfxlk.supabase.co";
const supabaseKey = "sb_publishable_emSBOsbTZrSXtNxnBZihsw_du9yIkoX";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

/* ===== COMPRESS√ÉO DE IMAGEM ===== */
async function comprimirImagem(file){
  return new Promise(resolve=>{
    const img = new Image();
    img.src = URL.createObjectURL(file);
    img.onload = ()=>{
      const canvas = document.createElement("canvas");
      const max = 900;
      let w = img.width, h = img.height;

      if(w > h && w > max){ h *= max / w; w = max; }
      else if(h > max){ w *= max / h; h = max; }

      canvas.width = w;
      canvas.height = h;
      canvas.getContext("2d").drawImage(img,0,0,w,h);
      canvas.toBlob(b => resolve(b), "image/jpeg", 0.7);
    }
  });
}

/* ===== CARREGAR MANUTEN√á√ïES ===== */
async function carregar(){
  const { data, error } = await supabase
    .from("manutencoes")
    .select("*")
    .order("created_at",{ascending:false});

  if(error){
    console.error(error);
    return;
  }

  lista.innerHTML = "";

  data.forEach(m=>{
    lista.innerHTML += `
      <div class="card">
        <h3>${m.local}</h3>
        <small>${m.data} ‚Ä¢ ${m.responsavel} ‚Ä¢ <b>${m.status}</b></small>
        <p>${m.descricao}</p>

        <div class="photos" id="p${m.id}"></div>

        <button onclick="editar('${m.id}')">‚úèÔ∏è Editar</button>
      </div>
    `;
    carregarFotos(m.id);
  });
}

/* ===== FOTOS ===== */
async function carregarFotos(id){
  const { data } = await supabase.storage
    .from("fotos")
    .list(id + "/");

  const div = document.getElementById("p"+id);
  if(!data || !div) return;

  div.innerHTML = "";

  data.forEach(f=>{
    const url = supabase.storage
      .from("fotos")
      .getPublicUrl(id + "/" + f.name)
      .data.publicUrl;

    div.innerHTML += `
      <img src="${url}">
      <button onclick="removerFoto('${id}','${f.name}')">üóëÔ∏è Remover foto</button>
    `;
  });
}

async function removerFoto(id,nome){
  await supabase.storage.from("fotos").remove([`${id}/${nome}`]);
  carregar();
}

/* ===== SALVAR ===== */
form.onsubmit = async e => {
  e.preventDefault();

  const manutencao = {
    local: local.value,
    descricao: descricao.value,
    data: data.value,
    responsavel: responsavel.value,
    status: status.value
  };

  let res;

  if(id.value){
    res = await supabase
      .from("manutencoes")
      .update(manutencao)
      .eq("id", id.value)
      .select()
      .single();
  }else{
    res = await supabase
      .from("manutencoes")
      .insert(manutencao)
      .select()
      .single();
  }

  if(res.error){
    console.error(res.error);
    return;
  }

  if(fotos.files.length){
    for(const f of fotos.files){
      const blob = await comprimirImagem(f);
      await supabase.storage
        .from("fotos")
        .upload(`${res.data.id}/${Date.now()}.jpg`, blob, { upsert:true });
    }
  }

  form.reset();
  id.value = "";
  carregar();
};

/* ===== EDITAR ===== */
async function editar(mid){
  const { data } = await supabase
    .from("manutencoes")
    .select("*")
    .eq("id", mid)
    .single();

  id.value = data.id;
  local.value = data.local;
  descricao.value = data.descricao;
  data.value = data.data;
  responsavel.value = data.responsavel;
  status.value = data.status;

  window.scrollTo({top:0,behavior:"smooth"});
}

carregar();
</script>

</body>
</html>
